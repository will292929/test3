<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Visual GitHub Pages Editor</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      overflow: hidden;
    }
    #editor {
      padding: 20px;
    }
    #editor iframe {
      width: 100%;
      height: calc(100vh - 60px);
      border: none;
    }
    #commitBtn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 10px 20px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
      z-index: 1000;
    }
    .hover-highlight {
      outline: 2px dashed red;
    }
    .edit-overlay {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border: 1px solid #ccc;
      padding: 20px;
      z-index: 2000;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>

<div id="editor">
  <iframe id="pageFrame"></iframe>
</div>

<button id="commitBtn">üíæ Commit Changes</button>

<script>
const USERNAME = "will292929";
const REPO = "test3";
let FILE_PATH = "index.html";
const BRANCH = "main";

let TOKEN = localStorage.getItem("github_token");
if (!TOKEN) {
  TOKEN = prompt("Enter your GitHub Personal Access Token:");
  if (TOKEN) localStorage.setItem("github_token", TOKEN);
  else alert("No token provided. Editor will not function.");
}

const frame = document.getElementById('pageFrame');
let spaceHeld = false;
let originalHTML = "";
let sha = "";

window.addEventListener('keydown', e => {
  if (e.code === 'Space') {
    e.preventDefault();
    if (!spaceHeld) {
      spaceHeld = true;
      // First hold: enable navigation mode only
    } else {
      const newFile = prompt(
        "Enter filename to edit (e.g., index.html, about.html):",
        FILE_PATH
      );
      if (newFile) {
        FILE_PATH = newFile;
        loadHTML();
      }
    }
  }
});
window.addEventListener('keyup', e => {
  if (e.code === 'Space') spaceHeld = false;
});

async function loadHTML() {
  try {
    const res = await fetch(
      `https://api.github.com/repos/${USERNAME}/${REPO}/contents/${FILE_PATH}`,
      {
        headers: { 'Authorization': `Bearer ${TOKEN}` }
      }
    );
    const data = await res.json();
    originalHTML = atob(data.content);
    sha = data.sha;
    const blob = new Blob([originalHTML], { type: 'text/html' });
    frame.src = URL.createObjectURL(blob);
  } catch (err) {
    alert('Failed to load file: ' + err);
  }
}

frame.onload = () => {
  const doc = frame.contentDocument;
  doc.querySelectorAll('a, img, button, span, div, p').forEach(el => {
    el.addEventListener('mouseover', () => el.classList.add('hover-highlight'));
    el.addEventListener('mouseout', () => el.classList.remove('hover-highlight'));
    el.addEventListener('click', e => {
      if (spaceHeld) return;
      e.preventDefault();
      const type = el.tagName.toLowerCase();
      const attr = type === 'a' ? 'href' : type === 'img' ? 'src' : null;

      // Create overlay
      const overlay = document.createElement('div');
      overlay.className = 'edit-overlay';
      overlay.innerHTML = `
        <label>Change Type:</label>
        <select id="editChoice">
          <option value="">Cancel</option>
          ${attr ? '<option value="url">URL</option>' : ''}
          <option value="text">Text</option>
          ${attr ? '<option value="gdrive">Google Drive Link</option>' : ''}
          ${attr ? '<option value="dormant">Make Dormant</option>' : ''}
        </select>
        <button id="editOk">OK</button>
      `;
      document.body.appendChild(overlay);

      document.getElementById('editOk').onclick = () => {
        const choice = document.getElementById('editChoice').value;
        document.body.removeChild(overlay);
        if (!choice) return;
        if (choice === 'url' && attr) {
          const current = el.getAttribute(attr) || '';
          const newVal = prompt(`Edit ${attr}:`, current);
          if (newVal !== null) el.setAttribute(attr, newVal);
        } else if (choice === 'text') {
          const newText = prompt('Edit text:', el.innerText);
          if (newText !== null) el.innerText = newText;
        } else if (choice === 'gdrive' && attr) {
          const gdrive = prompt('Paste Google Drive link:','');
          if (gdrive) el.setAttribute(attr, gdrive);
        } else if (choice === 'dormant' && attr) {
          el.removeAttribute(attr);
          el.innerText = '';
        }
      };
    });
  });
};

// Commit changes
const commitBtn = document.getElementById('commitBtn');
commitBtn.onclick = async () => {
  try {
    const doc = frame.contentDocument;
    const newHTML = doc.documentElement.outerHTML;
    const encoded = btoa(unescape(encodeURIComponent(newHTML)));

    const res = await fetch(
      `https://api.github.com/repos/${USERNAME}/${REPO}/contents/${FILE_PATH}`,
      {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${TOKEN}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: 'Commit from visual editor',
          content: encoded,
          sha: sha,
          branch: BRANCH
        })
      }
    );

    if (res.ok) {
      alert('‚úÖ Changes committed!');
      await loadHTML();
    } else {
      alert('‚ùå Commit failed.');
      console.error(await res.json());
    }
  } catch (err) {
    alert('Error: ' + err);
  }
};

// Initial load
loadHTML();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Visual GitHub Pages Editor</title>
  <style>
    body { font-family: sans-serif; margin: 0; overflow: hidden; }
    #editor { padding: 20px; }
    #editor iframe { width: 100%; height: calc(100vh - 60px); border: none; }
    #commitBtn { position: fixed; bottom: 20px; right: 20px; padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; z-index: 1000; }
    .hover-highlight { outline: 2px dashed red; }
    .edit-backdrop { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.3); z-index: 1999; }
    .edit-overlay { position: fixed; min-width: 320px; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border: 1px solid #ccc; padding: 20px; z-index: 2000; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .edit-overlay select, .edit-overlay button { margin-top: 10px; margin-right: 10px; }
    .dormant { display: none !important; }
  </style>
</head>
<body>
<div id="editor"><iframe id="pageFrame"></iframe></div>
<button id="commitBtn">ðŸ’¾ Commit Changes</button>
<script>
const USERNAME = 'will292929';
const REPO = 'test3';
let FILE_PATH = 'index.html';
const BRANCH = 'main';
let TOKEN = localStorage.getItem('github_token') || prompt('Enter GitHub Token:');
if (TOKEN) localStorage.setItem('github_token', TOKEN);

const frame = document.getElementById('pageFrame');
let spaceHeld = false, sha = '';

window.addEventListener('keydown', e => {
  if (e.code === 'Space') { e.preventDefault(); if (!spaceHeld) spaceHeld=true; else { let f=prompt('Filename to edit:', FILE_PATH); if(f){FILE_PATH=f; loadHTML();}} }
});
window.addEventListener('keyup', e=>{ if(e.code==='Space') spaceHeld=false; });

async function apiCommit(path, contentB64, message){
  const res=await fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/contents/${path}`,{
    method:'PUT', headers:{ 'Authorization':`Bearer ${TOKEN}`, 'Content-Type':'application/json' },
    body:JSON.stringify({ message, content:contentB64, sha: path===FILE_PATH?sha:undefined, branch:BRANCH })
  });
  return res.ok?await res.json():Promise.reject(await res.json());
}

async function loadHTML(){ try{
    const r=await fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/contents/${FILE_PATH}`,{ headers:{ 'Authorization':`Bearer ${TOKEN}` }});
    const j=await r.json();
    const html=atob(j.content);
    sha=j.sha;
    frame.src=URL.createObjectURL(new Blob([html],{type:'text/html'}));
  }catch(e){alert('Load failed:'+e);} }

frame.onload = () => {
  const doc = frame.contentDocument;

  // Remove any leftover overlays/backdrops
  document.querySelectorAll('.edit-backdrop, .edit-overlay').forEach(el => el.remove());

  // Only add editor to leaf nodes, and skip dormant ones
  doc.querySelectorAll('a,img,button,span,p,div').forEach(el=>{
    const tag = el.tagName.toLowerCase();
    if ((tag === 'div' || tag === 'span' || tag === 'p') && el.children.length) return;
    if (el.classList.contains('dormant')) return;

    el.addEventListener('mouseover',()=>el.classList.add('hover-highlight'));
    el.addEventListener('mouseout',()=>el.classList.remove('hover-highlight'));
    el.addEventListener('click', async e=>{
      if(spaceHeld) return;
      e.preventDefault();

      // Remove existing overlays/backdrops
      document.querySelectorAll('.edit-backdrop, .edit-overlay').forEach(el => el.remove());

      const type=el.tagName.toLowerCase();
      const attr=type==='a'?'href':type==='img'?'src':null;

      // Create backdrop and overlay
      const backdrop=document.createElement('div');
      const overlay=document.createElement('div');
      backdrop.className='edit-backdrop'; overlay.className='edit-overlay';

      // Position overlay near click, not offscreen
      const y = Math.min(e.clientY + 10, window.innerHeight - 180);
      const x = Math.min(e.clientX + 10, window.innerWidth - 350);
      overlay.style.top = y + 'px';
      overlay.style.left = x + 'px';
      overlay.style.transform = 'none';

      overlay.innerHTML = `
        <label style="margin-right:12px;">Change:</label>
        <select id="editChoice">
          <option value="">Cancel</option>
          <option value="url">URL</option>
          <option value="text">Text</option>
          <option value="browse">Browse & Upload Image</option>
          <option value="dormant">Make Dormant</option>
        </select>
        <button id="editOk">OK</button>
        <input type="file" id="imgInput" accept="image/*" style="display:none; margin-top:10px;" />
      `;

      document.body.append(backdrop, overlay);

      // Show/hide file input when selecting "browse"
      const select = overlay.querySelector('#editChoice');
      const imgInput = overlay.querySelector('#imgInput');
      select.onchange = () => {
        imgInput.style.display = (select.value === 'browse') ? 'block' : 'none';
      };

      // Clean up overlay
      backdrop.onclick = () => { overlay.remove(); backdrop.remove(); };

      document.getElementById('editOk').onclick = async () => {
        const choice = select.value;
        overlay.remove(); backdrop.remove();
        if (!choice) return;

        if (choice === 'url') {
          let current = attr ? el.getAttribute(attr) || '' : '';
          const newVal = prompt('Enter new URL:', current);
          if (newVal != null) {
            if (attr) el.setAttribute(attr, newVal);
            else {
              // Wrap in a link
              const wrapper = document.createElement('a');
              wrapper.href = newVal;
              wrapper.innerHTML = el.innerHTML;
              el.innerHTML = '';
              el.appendChild(wrapper);
            }
          }
        }
        else if (choice === 'text') {
          const nt = prompt('Edit text:', el.innerText);
          if (nt != null) el.innerText = nt;
        }
        else if (choice === 'browse') {
          imgInput.click();
          imgInput.onchange = async () => {
            const file = imgInput.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onloadend = async () => {
              const b64 = reader.result.split(',')[1];
              const fname = file.name.replace(/[^a-z0-9.\\-_]/gi, '_');
              await apiCommit(`images/${fname}`, b64, 'Upload image ' + fname);
              if (attr) el.setAttribute(attr, `images/${fname}`);
              else if (el.tagName.toLowerCase() !== 'img') {
                el.innerHTML = `<img src="images/${fname}" alt="" />`;
              }
              alert('âœ… Image uploaded and set!');
            };
            reader.readAsDataURL(file);
          };
          return; // Wait for input
        }
        else if (choice === 'dormant') {
          el.classList.add('dormant');
          if (attr) el.removeAttribute(attr);
          el.innerText = '';
        }
      };
    });
  });
};

// Commit HTML
const commitBtn=document.getElementById('commitBtn');
commitBtn.onclick=async()=>{
  try{
    const newHTML=frame.contentDocument.documentElement.outerHTML;
    const enc=btoa(unescape(encodeURIComponent(newHTML)));
    await apiCommit(FILE_PATH,enc,'Commit from editor');
    alert('âœ…Committed'); await loadHTML();
  }catch(e){alert('Commit failed:'+JSON.stringify(e));}
};

loadHTML();
</script>
</body>
</html>
